# ml_ops_1

## Архитектура решения
```
├── .gitignore
├── Dockerfile
├── README.md
├── app/
│ └── app.py # Ядро сервиса с обработчиком файлов
├── models/
│ └── lgb.txt # Сериализованная модель LGBM
├── src/
│ ├── preprocessing.py # Пайплайн обработки данных
│ └── scorer.py # Модуль прогнозирования
└── train_data/
│ └── train.csv # Данные для обучения (reference), необходимо скачать из соревнования
└── input/ # Директория для загрузки файлов на скоринг
└── output/ # Директория с результатами скоринга
└── output_example/ # Директория с примером результата
```

## Ключевые особенности

### Многоуровневое логирование
- Регистрация всех событий в файл `/app/logs/service.log`
- Консольный вывод для мониторинга в реальном времени
- 3 уровня детализации:
  - `INFO`: Основные этапы обработки
  - `DEBUG`: Детали преобразования данных
  - `ERROR`: Критические сбои с трейсбэками

### Пайплайн обработки данных (`preprocessing.py`)
1. **Временные признаки**:
   - Извлекаем: hour, year, month, day_of_month, day_of_week из transaction_time.
   - После извлечения столбец transaction_time удаляем.
   
2. **Геопространственные расчеты**:
   - Считаем три векторизованных расстояния Haversine:
        - клиент → мерчант
        - клиент → (0, 0)
        - (0, 0) → мерчант

   - Считаем три угла (bearing 0–360°) для тех же пар точек

3. **Категориальные переменные**:
   - Применяем CatBoost Target Encoder
   - После кодирования исходные строковые колонки удаляем

4. **Числовые признаки**:
   - Масштабируем все числовые столбцы RobustScaler

### Модельный слой (`scorer.py`)
- Порог классификации: 0.59
- Автоматическая загрузка модели при инициализации
- Батчевая обработка через `predict_proba`

## Быстрый старт

### Требования
- Docker 20.10+
- 2 ГБ свободного места
- Порты: только файловая система

### Запуск сервиса

1. Скачайте файл `train.csv` из соревнования https://www.kaggle.com/competitions/teta-ml-1-2025 и разместите в директории `./train_data`
2. Соберите образ
```bash
docker build -t fraud_detector .
```
3. Запустите контейнер с монтированием томов
```bash
docker run -it --rm -v ./input:/app/input:rw \
                    -v ./output:/app/output:rw \
                    fraud_detector
```
4. После запуска сервиса (появления в логах сообщения: `__main__ - INFO - File observer started`) можно приступать к скорингу данных:
 - Разместите файл формата test.csv из соревнования https://www.kaggle.com/competitions/teta-ml-1-2025 в директории `./input`
 - Подождите выполнения препроцессинга и скоринга датасета (в логах будет указано название сформированного файла)
 - Полученный результат моделирования будет выгружен сервисом в директорию `./output`


Копирование файла в директорию input в контейнере не распознается как on_created, 
хотя при обычном запуске это работает, поэтому добавила on_any_event
